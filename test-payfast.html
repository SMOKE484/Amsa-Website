<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayFast Integration Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid #e0e0e0;
        }
        
        .test-section h2 {
            color: #2e5c89;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2e5c89;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2e5c89;
            box-shadow: 0 0 0 3px rgba(46, 92, 137, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2e5c89, #1e4060);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e4060, #2e5c89);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .results-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        
        .results-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-header h2 {
            color: #2e5c89;
            margin: 0;
        }
        
        .results-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }
        
        .log-entry.info {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #1565c0;
        }
        
        .log-entry.success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .log-entry.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .log-entry.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
            color: #ef6c00;
        }
        
        .timestamp {
            color: #666;
            font-size: 11px;
            margin-right: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
        .status-info { background: #2196f3; }
        
        .signature-comparison {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .signature-match {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .signature-mismatch {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí PayFast Integration Tester</h1>
            <p>Test your PayFast integration with real-time signature validation</p>
        </div>

        <div class="test-grid">
            <!-- Configuration Section -->
            <div class="test-section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-group">
                    <label for="merchant_id">Merchant ID *</label>
                    <input type="text" id="merchant_id" class="form-control" value="10042342" required>
                </div>
                <div class="form-group">
                    <label for="merchant_key">Merchant Key *</label>
                    <input type="text" id="merchant_key" class="form-control" value="sugi9zwxtq6rg" required>
                </div>
                <div class="form-group">
                    <label for="passphrase">Passphrase *</label>
                    <input type="text" id="passphrase" class="form-control" value="alusanimathsandscience" required>
                </div>
                <div class="form-group">
                    <label for="environment">Environment</label>
                    <select id="environment" class="form-control">
                        <option value="sandbox">Sandbox</option>
                        <option value="live">Live</option>
                    </select>
                </div>
            </div>

            <!-- Test Data Section -->
            <div class="test-section">
                <h2>üìä Test Data</h2>
                <div class="form-group">
                    <label for="amount">Amount (R) *</label>
                    <input type="text" id="amount" class="form-control" value="1" required>
                    <small style="color: #666; font-size: 12px;">Use whole numbers (1 instead of 1.00)</small>
                </div>
                <div class="form-group">
                    <label for="item_name">Item Name *</label>
                    <input type="text" id="item_name" class="form-control" value="Alusani Academy Application" required>
                </div>
                <div class="form-group">
                    <label for="item_description">Item Description</label>
                    <input type="text" id="item_description" class="form-control" value="Application Processing Fee">
                </div>
                <div class="form-group">
                    <label for="name_first">First Name</label>
                    <input type="text" id="name_first" class="form-control" value="Test">
                </div>
                <div class="form-group">
                    <label for="name_last">Last Name</label>
                    <input type="text" id="name_last" class="form-control" value="User">
                </div>
                <div class="form-group">
                    <label for="email_address">Email Address</label>
                    <input type="email" id="email_address" class="form-control" value="test@test.com">
                </div>
                <div class="form-group">
                    <label for="m_payment_id">Payment ID</label>
                    <input type="text" id="m_payment_id" class="form-control" value="">
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="test-section">
            <h2>üöÄ Test Actions</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="testSignatureGeneration()">
                    <span>üîç</span> Test Signature Generation
                </button>
                <button class="btn btn-secondary" onclick="testAllMethods()">
                    <span>üìã</span> Test All Methods
                </button>
                <button class="btn btn-success" onclick="testPayfastSubmission()">
                    <span>üí∞</span> Test PayFast Submission
                </button>
                <button class="btn btn-danger" onclick="clearResults()">
                    <span>üóëÔ∏è</span> Clear Results
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <h2>üìà Test Results</h2>
                <button class="btn btn-secondary" onclick="exportResults()">
                    <span>üì•</span> Export Logs
                </button>
            </div>
            <div id="results" class="results-content">
                <div class="log-entry info">
                    <span class="timestamp" id="current-time"></span>
                    <span class="status-indicator status-info"></span>
                    PayFast Integration Tester Ready! Configure your settings and run tests.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        document.getElementById('m_payment_id').value = 'TEST_' + Date.now();
        document.getElementById('current-time').textContent = new Date().toLocaleTimeString();

        // Utility functions
        function getConfig() {
            return {
                merchant_id: document.getElementById('merchant_id').value.trim(),
                merchant_key: document.getElementById('merchant_key').value.trim(),
                passphrase: document.getElementById('passphrase').value.trim(),
                environment: document.getElementById('environment').value,
                amount: document.getElementById('amount').value.trim(),
                item_name: document.getElementById('item_name').value.trim(),
                item_description: document.getElementById('item_description').value.trim(),
                name_first: document.getElementById('name_first').value.trim(),
                name_last: document.getElementById('name_last').value.trim(),
                email_address: document.getElementById('email_address').value.trim(),
                m_payment_id: document.getElementById('m_payment_id').value.trim() || 'TEST_' + Date.now()
            };
        }

        function getPayfastUrl(environment) {
            return environment === 'sandbox' 
                ? 'https://sandbox.payfast.co.za/eng/process'
                : 'https://www.payfast.co.za/eng/process';
        }

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span class="status-indicator status-${type}"></span>
                ${message}
            `;
            
            results.appendChild(logEntry);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = `
                <div class="log-entry info">
                    <span class="timestamp" id="current-time"></span>
                    <span class="status-indicator status-info"></span>
                    Logs cleared. Ready for new tests.
                </div>
            `;
            document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
        }

        function exportResults() {
            const results = document.getElementById('results').innerText;
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payfast-test-${Date.now()}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Signature generation using PayFast's correct method
        function generateSignature(paymentData, passphrase) {
            const fieldsInOrder = [
                'merchant_id', 'merchant_key', 'return_url', 'cancel_url', 'notify_url',
                'name_first', 'name_last', 'email_address', 'm_payment_id', 'amount',
                'item_name', 'item_description'
            ];
            
            let signatureString = '';
            
            fieldsInOrder.forEach(key => {
                if (paymentData[key] && paymentData[key] !== '') {
                    if (signatureString !== '') signatureString += '&';
                    signatureString += `${key}=${paymentData[key]}`;
                }
            });
            
            if (passphrase) {
                signatureString += `&passphrase=${passphrase}`;
            }
            
            return {
                string: signatureString,
                signature: CryptoJS.MD5(signatureString).toString()
            };
        }

        // Test functions
        function testSignatureGeneration() {
            const config = getConfig();
            
            log('=== üîç TESTING SIGNATURE GENERATION ===', 'info');
            
            const paymentData = {
                'merchant_id': config.merchant_id,
                'merchant_key': config.merchant_key,
                'return_url': window.location.origin + '/success',
                'cancel_url': window.location.origin + '/cancel',
                'notify_url': '',
                'name_first': config.name_first,
                'name_last': config.name_last,
                'email_address': config.email_address,
                'm_payment_id': config.m_payment_id,
                'amount': config.amount,
                'item_name': config.item_name,
                'item_description': config.item_description
            };

            const result = generateSignature(paymentData, config.passphrase);
            
            log('Payment Data:', 'info');
            log(JSON.stringify(paymentData, null, 2), 'info');
            log('Signature String:', 'info');
            log(result.string, 'info');
            log('Generated Signature:', 'success');
            log(result.signature, 'success');
            
            log('=== ‚úÖ SIGNATURE GENERATION COMPLETE ===', 'success');
        }

        function testAllMethods() {
            const config = getConfig();
            
            log('=== üìã TESTING ALL SIGNATURE METHODS ===', 'info');
            
            const testData = {
                merchant_id: config.merchant_id,
                merchant_key: config.merchant_key,
                return_url: 'https://example.com/success',
                amount: config.amount,
                item_name: config.item_name
            };

            const methods = [
                {
                    name: 'Documentation Order + No Encoding',
                    generate: (data, passphrase) => {
                        const order = ['merchant_id', 'merchant_key', 'return_url', 'amount', 'item_name'];
                        let str = '';
                        order.forEach(key => {
                            if (data[key]) {
                                if (str !== '') str += '&';
                                str += `${key}=${data[key]}`;
                            }
                        });
                        return str + `&passphrase=${passphrase}`;
                    }
                },
                {
                    name: 'Alphabetical Order + No Encoding',
                    generate: (data, passphrase) => {
                        let str = '';
                        Object.keys(data).sort().forEach(key => {
                            if (str !== '') str += '&';
                            str += `${key}=${data[key]}`;
                        });
                        return str + `&passphrase=${passphrase}`;
                    }
                },
                {
                    name: 'Documentation Order + URL Encoding',
                    generate: (data, passphrase) => {
                        const order = ['merchant_id', 'merchant_key', 'return_url', 'amount', 'item_name'];
                        let str = '';
                        order.forEach(key => {
                            if (data[key]) {
                                if (str !== '') str += '&';
                                str += `${key}=${encodeURIComponent(data[key]).replace(/%20/g, '+')}`;
                            }
                        });
                        return str + `&passphrase=${encodeURIComponent(passphrase).replace(/%20/g, '+')}`;
                    }
                }
            ];

            methods.forEach(method => {
                const string = method.generate(testData, config.passphrase);
                const signature = CryptoJS.MD5(string).toString();
                log(`${method.name}:`, 'info');
                log(`String: ${string}`, 'info');
                log(`Signature: ${signature}`, 'info');
            });

            log('=== ‚úÖ ALL METHODS TESTED ===', 'success');
        }

        function testPayfastSubmission() {
            const config = getConfig();
            
            log('=== üí∞ TESTING PAYFAST SUBMISSION ===', 'info');

            const paymentData = {
                'merchant_id': config.merchant_id,
                'merchant_key': config.merchant_key,
                'return_url': window.location.origin + '/success',
                'cancel_url': window.location.origin + '/cancel',
                'notify_url': '',
                'name_first': config.name_first,
                'name_last': config.name_last,
                'email_address': config.email_address,
                'm_payment_id': config.m_payment_id,
                'amount': config.amount,
                'item_name': config.item_name,
                'item_description': config.item_description
            };

            const result = generateSignature(paymentData, config.passphrase);
            
            log('Payment Data:', 'info');
            log(JSON.stringify(paymentData, null, 2), 'info');
            log('Signature String:', 'info');
            log(result.string, 'info');
            log('Generated Signature:', 'success');
            log(result.signature, 'success');

            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = getPayfastUrl(config.environment);
            form.style.display = 'none';
            form.target = '_blank';

            const fieldsInOrder = [
                'merchant_id', 'merchant_key', 'return_url', 'cancel_url', 'notify_url',
                'name_first', 'name_last', 'email_address', 'm_payment_id', 'amount',
                'item_name', 'item_description'
            ];

            fieldsInOrder.forEach(key => {
                if (paymentData[key] && paymentData[key] !== '') {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = paymentData[key];
                    form.appendChild(input);
                }
            });

            const signatureInput = document.createElement('input');
            signatureInput.type = 'hidden';
            signatureInput.name = 'signature';
            signatureInput.value = result.signature;
            form.appendChild(signatureInput);

            document.body.appendChild(form);
            
            log('Submitting to PayFast...', 'success');
            log('You should be redirected to PayFast in a new tab.', 'info');
            
            form.submit();
            setTimeout(() => {
                document.body.removeChild(form);
            }, 1000);
        }

        // Additional diagnostic function
        function testPayfastExample() {
            const paymentData = {
                'merchant_id': '10042342',
                'merchant_key': 'sugi9zwxtq6rg',
                'amount': '100',
                'item_name': 'smoke'
            };

            const passphrase = 'alusanimathsandscience';

            let signatureString = 'merchant_id=10042342&merchant_key=sugi9zwxtq6rg&amount=100&item_name=smoke';
            signatureString += `&passphrase=${passphrase}`;
            
            const signature = CryptoJS.MD5(signatureString).toString();
            
            log('PayFast Example Test:', 'info');
            log('Expected Signature: ddfb6245a9c92c7b504aface8de9b63d', 'info');
            log('Our Signature: ' + signature, 'info');
            
            if (signature === 'ddfb6245a9c92c7b504aface8de9b63d') {
                log('‚úÖ SIGNATURE MATCHES PAYFAST EXAMPLE!', 'success');
            } else {
                log('‚ùå Signature does not match PayFast example', 'error');
            }
        }

        // Run example test on load
        setTimeout(testPayfastExample, 1000);
    </script>
</body>
</html>